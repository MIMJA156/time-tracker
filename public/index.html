<!DOCTYPE html>
<html lang="en">

<head>
    <script src="./JS/jquery-3.6.0.js"></script>
    <script src="./JS/chart.js"></script>
</head>
<style>
    .top-bar {
        width: 100%;
        text-align: center;
        font-size: 30px;
    }

    .left {
        float: left;
    }

    .right {
        float: right;
    }

    .button {
        background-color: cyan;
        border: none;
        height: 33px;
        display: flex;
        align-items: center;
        font-size: 15px;
    }

    .button:hover {
        filter: brightness(0.9);
        cursor: pointer;
    }

    #current-date {
        font-size: 25px;
    }

    .graph-container {
        padding-left: 20px;
        padding-right: 20px;
    }
</style>

<body>
    <div class="top-bar">
        <button class="left button" id="back"><img src="./SVGS/chevron-left.svg"><span id="back-text"></span></button>
        <span id="current-date"></span>
        <button class="right button" id="forward"><span id="forward-text"></span><img
                src="./SVGS/chevron-right.svg"></button>
    </div>

    <div class="graph-container">
        <canvas id="chart"></canvas>
    </div>
</body>

<script>
    var given = {
        current: "2022-1-23/2022-1-29",
        "2022-1-2/2022-1-8": {
            active: [2000, 2000, 2000, 2000, 2000, 2000, 2000]
        },
        "2022-1-9/2022-1-15": {
            active: [1500, 1500, 1500, 1500, 1500, 1500, 1500]
        },
        "2022-1-16/2022-1-22": {
            active: [1000, 1000, 1000, 1000, 1000, 1000, 1000]
        },
        "2022-1-23/2022-1-29": {
            active: [500, 500, 500, 500, 500, 500, 500]
        }
    };

    let ping = () => {
        $.ajax({
            url: `http://localhost:${window.location.port}/api/ping`,
            type: "GET",
        }).done((data) => {
            setTimeout(() => {
                ping();
            }, 1000 * 55);
        });
    }

    ping();

    $.ajax({
        url: `http://localhost:${window.location.port}/api/get-data`,
        type: `POST`
    }).done((given) => {
        $('#current-date').text(given.current);

        const barChart = new Chart($('#chart'), {
            type: 'bar',
            data: {
                labels: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday',
                    'Saturday'
                ],
                datasets: [{
                    label: 'Time Spent Coding This Week',
                    backgroundColor: ['#000000'],
                    data: given[given.current].active,
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let hours = `${(given[given.current].active[context.dataIndex] / 60) /
                                60}`.split('.')[0];
                                let minutes = `${((given[given.current].active[context.dataIndex] / 60) - (hours *
                                60))}`.split('.')[0];

                                let h_s = `${hours} hr`;
                                let m_s = `${minutes} min`;

                                if (hours <= 0) h_s = '';
                                if (minutes <= 0) m_s = '';
                                if (hours > 1) h_s = `${h_s}s`;
                                if (minutes > 1) m_s = `${m_s}s`;

                                return `${h_s} ${m_s}`;
                            }
                        }
                    }
                }
            }
        });

        $('#back').click(() => {
            doMovement(false);
            $('#current-date').text(given.current);
        });

        $('#forward').click(() => {
            doMovement(true);
            $('#current-date').text(given.current);
        });

        function doMovement(type) {
            let current = given.current;
            let cut = current.split('/');

            let firstDate = cut[0].split('-');
            let secondDate = cut[1].split('-');

            for (let i = 0; i < firstDate.length; i++) {
                firstDate[i] = parseInt(firstDate[i]);
            }
            for (let i = 0; i <
                secondDate.length; i++) {
                secondDate[i] = parseInt(secondDate[i]);
            }

            if (type) {
                firstDate[2] += 7;
                secondDate[2] += 7;
            } else {
                firstDate[2] -= 7;
                secondDate[2] -= 7;
            }

            if (firstDate[2] < 1) {
                firstDate[1] -= 1;
                if (firstDate[1] < 1) {
                    firstDate[0] -= 1;
                    firstDate[1] = 12;
                }
                firstDate[2] = getDaysInMonth(firstDate[0], firstDate[1]) + firstDate[2];
            }
            if (secondDate[2] < 1) {
                secondDate[1] -= 1;
                if (secondDate[1] < 1) {
                    secondDate[0] -= 1;
                    secondDate[1] = 12;
                }
                secondDate[2] = getDaysInMonth(secondDate[0], secondDate[1]) + secondDate[2];
            }
            if (!given[
                    `${firstDate[0]}-${firstDate[1]}-${firstDate[2]}/${secondDate[0]}-${secondDate[1]}-${secondDate[2]}`
                ]) {
                return;
            };

            given.current =
                `${firstDate[0]}-${firstDate[1]}-${firstDate[2]}/${secondDate[0]}-${secondDate[1]}-${secondDate[2]}`;

            barChart.data.datasets[0].data = given[given.current].active;
            barChart.update();
        }

        function getDaysInMonth(year, month) {
            return parseFloat(new Date(year, month, 0).getDate());
        };
    });
</script>

</html>