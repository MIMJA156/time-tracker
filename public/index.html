<!DOCTYPE html>
<html lang="en">

<head>
    <script src="./dependances/chart.js"></script>
    <script src="./dependances/jquery-3.6.0.js"></script>
</head>
<style>
    .top-bar {
        width: 100%;
        text-align: center;
    }

    .left {
        float: left;
    }

    .right {
        float: right;
    }
</style>

<body>
    <div class="top-bar">
        <button class="left" id="back">Back One Week</button>
        <span id="time-till-next-reload-span">2</span>
        <button class="right" id="forward">Forward One Week</button>
    </div>

    <canvas id="chart"></canvas>
</body>

<!--Week Change Buttons-->
<script>
    var inTheFuture = 0;

    const currentWeek = () => {
        let today = new Date();
        let dd = String(today.getDate()).padStart(2, '0');
        let mm = String(today.getMonth() + 1).padStart(2, '0');
        let yyyy = today.getFullYear();

        today = `${parseFloat(yyyy)}/${parseFloat(mm)}/${parseFloat(dd) + inTheFuture}`;
        return today;
    }
</script>

<!--Updating graph and initail boot up.-->
<script>
    var timeCounter;
    const port = window.location.port;

    $('#time-till-next-reload-span').text(`Initail Query...`);

    $.ajax({
        url: `http://localhost:${port}`,
        type: `POST`,
        headers: {
            'type': 'query',
            'week': currentWeek()
        }
    }).done((info) => {
        $('#forward').click(() => {
            inTheFuture += 7;
            startNextQuery(0);
        });

        $('#back').click(() => {
            inTheFuture -= 7;
            startNextQuery(0);
        });

        const chart = document.getElementById('chart');

        var time = [];

        info.forEach(element => {
            if (element == null) return time[time.length] = 0;
            time[time.length] = element.active;
        });

        var hours = [];

        time.forEach(element => {
            let difference = 0;
            if ((element / 60) >= 1) difference = element / 60 / 60;
            hours[hours.length] = difference;
        });

        const barChart = new Chart(chart, {
            type: 'bar',
            data: {
                labels: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday',
                    'Saturday'
                ],
                datasets: [{
                    label: 'Time Spent Coding This Week',
                    borderColor: '#00FF00',
                    backgroundColor: '#C3B1E1',
                    data: hours,
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let hours = `${(time[context.dataIndex] / 60) / 60}`.split('.')[0];
                                let minutes = `${((time[context.dataIndex] / 60) - (hours * 60))}`
                                    .split('.')[0];

                                let h_s = `${hours} hr`;
                                let m_s = `${minutes} min`;

                                if (hours <= 0) h_s = '';
                                if (minutes <= 0) m_s = '';
                                if (hours > 1) h_s = `${h_s}s`;
                                if (minutes > 1) m_s = `${m_s}s`;

                                return `${h_s} ${m_s}`;
                            }
                        }
                    }
                }
            }
        })

        startNextQuery(15);
        function startNextQuery(givenloops) {
            let loops = givenloops;
            clearInterval(timeCounter);
            timeCounter = setInterval(() => {
                loops--;
                $('#time-till-next-reload-span').text(`Next Query in ${loops + 1} seconds.`);
                if (loops + 1 <= 0) {
                    clearInterval(timeCounter);

                    $('#time-till-next-reload-span').text(`Sending Query...`);

                    $.ajax({
                        url: `http://localhost:${port}`,
                        type: `POST`,
                        headers: {
                            'type': 'query',
                            'week': currentWeek()
                        }
                    }).done((info) => {
                        time = [];

                        info.forEach(element => {
                            if (element == null) return time[time.length] = 0;
                            time[time.length] = element.active;
                        });

                        hours = [];

                        time.forEach(element => {
                            let difference = 0;
                            if ((element / 60) >= 1) difference = element / 60 / 60;
                            hours[hours.length] = difference;
                        });

                        barChart.data.datasets[0].data = hours;

                        barChart.update();

                        startNextQuery(15);
                    });
                }
            }, 1000);
        }
    });
</script>

</html>